import streamlit as st
import pandas as pd
import plotly.express as px
import requests
from io import StringIO

# GitHub raw URL (파일 경로)
file_url = "https://raw.githubusercontent.com/skywind99/25vibecoding1/main/pages/202504_202504_연령별인구현황_월간.csv"

# requests로 파일을 다운로드
response = requests.get(file_url)

# 파일이 성공적으로 다운로드되었는지 확인
if response.status_code == 200:
    # CSV 파일을 pandas로 읽기
    data_1 = pd.read_csv(StringIO(response.text), encoding='cp949')

    # 실제 컬럼명 확인
    st.write("파일의 컬럼명:", data_1.columns)
    st.write("컬럼 수:", len(data_1.columns))

    # 데이터 일부 확인
    st.write("파일의 일부 데이터:", data_1.head())

    # 필요한 컬럼만 선택
    data_1_filtered = data_1[['행정구역', 
                              '2025년04월_남_0~9세', '2025년04월_남_10~19세', '2025년04월_남_20~29세', 
                              '2025년04월_남_30~39세', '2025년04월_남_40~49세', '2025년04월_남_50~59세', 
                              '2025년04월_남_60~69세', '2025년04월_남_70~79세', '2025년04월_남_80~89세', 
                              '2025년04월_남_90~99세', '2025년04월_남_100세 이상',
                              '2025년04월_여_0~9세', '2025년04월_여_10~19세', '2025년04월_여_20~29세', 
                              '2025년04월_여_30~39세', '2025년04월_여_40~49세', '2025년04월_여_50~59세', 
                              '2025년04월_여_60~69세', '2025년04월_여_70~79세', '2025년04월_여_80~89세', 
                              '2025년04월_여_90~99세', '2025년04월_여_100세 이상']]

    # 숫자 데이터로 변환
    data_1_filtered = data_1_filtered.apply(pd.to_numeric, errors='coerce')

    # Plotly로 연령대별 남성, 여성 인구 비교 시각화
    fig = px.bar(data_1_filtered,
                 x='행정구역',
                 y=['2025년04월_남_0~9세', '2025년04월_남_10~19세', '2025년04월_남_20~29세', 
                     '2025년04월_남_30~39세', '2025년04월_남_40~49세', '2025년04월_남_50~59세', 
                     '2025년04월_남_60~69세', '2025년04월_남_70~79세', '2025년04월_남_80~89세', 
                     '2025년04월_남_90~99세', '2025년04월_남_100세 이상',
                     '2025년04월_여_0~9세', '2025년04월_여_10~19세', '2025년04월_여_20~29세', 
                     '2025년04월_여_30~39세', '2025년04월_여_40~49세', '2025년04월_여_50~59세', 
                     '2025년04월_여_60~69세', '2025년04월_여_70~79세', '2025년04월_여_80~89세', 
                     '2025년04월_여_90~99세', '2025년04월_여_100세 이상'],
                 title="연령대별 남성, 여성 인구 비교",
                 labels={'value': '인구수', 'variable': '연령대'},
                 barmode='stack')

    # 그래프 출력
    st.plotly_chart(fig)

else:
    st.error("파일을 다운로드할 수 없습니다.")
